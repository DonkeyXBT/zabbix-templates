zabbix_export:
  version: '6.4'

  template_groups:
    - uuid: 1b3c9b7e-2c5a-4f2d-9a61-8f9c2d1a6b3e
      name: Templates/Power

  templates:
    - uuid: 6d7f0b2a-1c3e-4a5b-8d9f-1a2b3c4d5e6f
      template: 'Template APC ATS AP7721 (SNMP Generic, v3-ready)'
      name: 'Template APC ATS AP7721 (SNMP Generic, v3-ready)'
      description: |
        Generic SNMP template for APC ATS AP7721.
        Works with SNMPv2c or SNMPv3 (SNMPv3 is configured on the host SNMP interface).
        Uses standard MIBs:
        - SNMPv2-MIB
        - IF-MIB (HC counters)

        ATS-only values (A/B source, transfers, alarms) need vendor OIDs and are not included.
      groups:
        - name: Templates/Power

      macros:
        - macro: '{$IF.UTIL.MAX}'
          value: '90'
        - macro: '{$IF.ERRORS.MAX}'
          value: '5'

      items:
        - uuid: 3a4e2c1b-7d8f-4a21-8f64-2b3c4d5e6f70
          name: 'SNMP: sysName'
          type: SNMP_AGENT
          key: 'apc.ats.sysName'
          snmp_oid: '1.3.6.1.2.1.1.5.0'
          value_type: TEXT
          delay: 1h
          history: 7d
          trends: '0'
          tags:
            - tag: component
              value: system

        - uuid: 4b1d9e7a-2c3f-4e5a-9b61-1a2b3c4d5e6f
          name: 'SNMP: sysDescr'
          type: SNMP_AGENT
          key: 'apc.ats.sysDescr'
          snmp_oid: '1.3.6.1.2.1.1.1.0'
          value_type: TEXT
          delay: 1h
          history: 7d
          trends: '0'
          tags:
            - tag: component
              value: system

        - uuid: 5c2a1f0e-8b7d-4c6a-8a91-9f0e1d2c3b4a
          name: 'SNMP: sysUpTimeInstance'
          type: SNMP_AGENT
          key: 'apc.ats.sysUpTime'
          snmp_oid: '1.3.6.1.2.1.1.3.0'
          value_type: UNSIGNED
          units: uptime
          delay: 5m
          history: 30d
          trends: 365d
          tags:
            - tag: component
              value: system

      discovery_rules:
        - uuid: 7d3c2b1a-4e5f-4a6b-9c8d-1e2f3a4b5c6d
          name: 'Interfaces (IF-MIB)'
          type: SNMP_AGENT
          key: 'apc.ats.if.discovery'
          delay: 1h
          lifetime: 7d
          snmp_oid: 'discovery[{#IFNAME},1.3.6.1.2.1.31.1.1.1.1]'

          item_prototypes:
            - uuid: 8e4d3c2b-1a0f-4b6c-8d91-2c3b4a5d6e7f
              name: 'IF {#IFNAME}: Oper status'
              type: SNMP_AGENT
              key: 'apc.ats.ifOperStatus[{#SNMPINDEX}]'
              snmp_oid: '1.3.6.1.2.1.2.2.1.8.{#SNMPINDEX}'
              value_type: UNSIGNED
              delay: 1m
              tags:
                - tag: component
                  value: interface
                - tag: ifname
                  value: '{#IFNAME}'

            - uuid: 9f5e4d3c-2b1a-4c7d-8a90-3b4a5c6d7e8f
              name: 'IF {#IFNAME}: In (bits/s)'
              type: SNMP_AGENT
              key: 'apc.ats.ifInBps[{#SNMPINDEX}]'
              snmp_oid: '1.3.6.1.2.1.31.1.1.1.6.{#SNMPINDEX}'
              value_type: UNSIGNED
              units: bps
              delay: 1m
              preprocessing:
                - type: CHANGE_PER_SECOND
                - type: MULTIPLIER
                  parameters: ['8']
              tags:
                - tag: component
                  value: traffic
                - tag: ifname
                  value: '{#IFNAME}'

            - uuid: a06f5e4d-3c2b-4d8e-9b71-4a5c6d7e8f90
              name: 'IF {#IFNAME}: Out (bits/s)'
              type: SNMP_AGENT
              key: 'apc.ats.ifOutBps[{#SNMPINDEX}]'
              snmp_oid: '1.3.6.1.2.1.31.1.1.1.10.{#SNMPINDEX}'
              value_type: UNSIGNED
              units: bps
              delay: 1m
              preprocessing:
                - type: CHANGE_PER_SECOND
                - type: MULTIPLIER
                  parameters: ['8']
              tags:
                - tag: component
                  value: traffic
                - tag: ifname
                  value: '{#IFNAME}'

            - uuid: b17a6f5e-4d3c-4e9f-8a62-5c6d7e8f9012
              name: 'IF {#IFNAME}: Speed (bps)'
              type: SNMP_AGENT
              key: 'apc.ats.ifSpeedBps[{#SNMPINDEX}]'
              snmp_oid: '1.3.6.1.2.1.31.1.1.1.15.{#SNMPINDEX}'
              value_type: UNSIGNED
              units: bps
              delay: 1h
              preprocessing:
                - type: MULTIPLIER
                  parameters: ['1000000']
              tags:
                - tag: component
                  value: interface
                - tag: ifname
                  value: '{#IFNAME}'

          trigger_prototypes:
            - uuid: c28b7a6f-5e4d-4f80-8b73-6d7e8f901234
              name: 'IF {#IFNAME}: Link down'
              expression: 'last(/Template APC ATS AP7721 (SNMP Generic, v3-ready)/apc.ats.ifOperStatus[{#SNMPINDEX}])<>1'
              priority: HIGH
              tags:
                - tag: scope
                  value: availability
